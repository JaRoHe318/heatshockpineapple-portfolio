<div class="viewer-wrapper">
  <div id="viewport" class="protein-container"></div>
  
  <div id="loading-overlay" class="loading-state">
    <span class="mono-meta">Loading 3D Structure...</span>
  </div>
</div>

<script>
  async function initProteinViewer() {
    const viewport = document.getElementById("viewport");
    const loader = document.getElementById("loading-overlay");
    
    if (!viewport) return;

    try {
      const NGLModule = await import('ngl');
      const NGL = NGLModule; 

      viewport.innerHTML = ""; 

      const stage = new NGL.Stage("viewport", {
        backgroundColor: "white", 
        tooltip: false
      });

      const handleResize = () => stage.handleResize();
      window.addEventListener("resize", handleResize);

      // Load PDB Data
      const component = await stage.loadFile("rcsb://5NRO");

      if (component) {
        // SUCCESS: Hide loading overlay
        if (loader) loader.style.display = 'none';

        // 1. PROTEIN: Now matches your "Action/Data" Blue
        component.addRepresentation("cartoon", {
          color: "#1f6f78",  // <-- PETROL BLUE (Was #2d5a45)
          aspectRatio: 3.0,
          opacity: 0.9,
          roughness: 1.0
        });

        // 2. LIGAND: Now matches your "Highlight" Gold
        component.addRepresentation("ball+stick", {
          sele: "ligand",
          color: "#FFD700",  // <-- KODAK GOLD (Was #c4835f)
          scale: 2.0
        });

        component.autoView();
        stage.setSpin(true);
      }
    } catch (err: any) {
      console.error("NGL Load Error:", err);
      const loadText = document.querySelector('#loading-overlay span');
      if (loadText) {
        loadText.textContent = "Error loading structure.";
        loadText.setAttribute("style", "color: var(--accent-primary);");
      }
    }
  }

  // Lifecycle Hooks
  initProteinViewer();
  document.addEventListener('astro:page-load', initProteinViewer);
</script>

<style>
  .viewer-wrapper {
    position: relative;
    width: 100%;
    max-width: 100%;
    height: 400px;
  }

  .protein-container {
    width: 100%;
    height: 100%;
    background: var(--bg-surface);
    /* Border is handled by the parent figure-frame in science.astro */
    border-radius: 4px;
    cursor: grab;
  }

  .protein-container:active {
    cursor: grabbing;
  }

  .loading-state {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--bg-surface);
    z-index: 10;
    pointer-events: none;
    transition: opacity 0.3s ease;
  }
  
  .loading-state span {
    color: var(--text-muted);
    font-size: 0.9rem;
  }

  @media (max-width: 600px) {
    .viewer-wrapper {
      height: 300px;
    }
  }
</style>